---
title: "HW3_yh3683"
author: "Yining He"
date: "2024-10-08"
output: github_document
---

# Problem 1
devtools::install_github("p8105/p8105.datasets")


```{r include=FALSE}
library(p8105.datasets)
library(ggridges)
library(tidyverse)
library(ggplot2)
library(janitor)
library(lubridate)
library(patchwork)
```


```{r}
data("ny_noaa")
```

```{r include=FALSE}
dataset_summary <- list(
  n_rows = nrow(ny_noaa),
  n_columns = ncol(ny_noaa),
  column_names = colnames(ny_noaa)
)
view(dataset_summary)
```

The dataset has `r nrow(ny_noaa)` observation and `r ncol(ny_noaa)` variables. The key variable in the dataset are `r colnames(ny_noaa)`.

```{r echo=FALSE}
missing_data_summary <- ny_noaa |>
  summarize(
    prcp_missing = mean(is.na(prcp)),
    snow_missing = mean(is.na(snow)),
    snwd_missing = mean(is.na(snwd)),
    tmax_missing = mean(is.na(tmax)),
    tmin_missing = mean(is.na(tmin))
  )
view(missing_data_summary)
```

The ny_noaa dataset shows 5.6% missing values for precipitation, 14.7% for snowfall, 22.8% for snow depth, and 43.7% missing for both maximum and minimum temperatures. This high level of maximum and minmun temeratures missingness, , may impact temperature trend analysis.

```{r echo=FALSE}
ny_noaa <- ny_noaa |>
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin),
    prcp = as.numeric(prcp),
    snow = as.numeric(snow)
  )
ny_noaa_cleaned <- ny_noaa |>
  mutate(
    year = year(date),
    month = month(date, label = TRUE),
    day = day(date),
    tmax = tmax / 10,     
    tmin = tmin / 10,     
    prcp = prcp / 10      
  )
snowfall_distribution <- ny_noaa_cleaned |>
  filter(!is.na(snow)) |>
  count(snow) |>
  arrange(desc(n))
head(snowfall_distribution)
```

The most frequently recorded snowfall amount is 0 mm, with 2,008,508 occurrences, which indicates that snow was absent on most days in this dataset.


#### Answer questions about the data(Answers)
```{r}
data("ny_noaa")
```
This dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. Variables include weather station id, date of observation,  (tenths of mm), snowfall (mm), snow depth (mm), and min and max temperature (tenths of degrees C).

Below we clean the data, creating separate variables for year, month, and day and converting `tmax` and `tmin` to numeric. We find that 0 is the most commonly observed value for snowfall. This is because most days of the year, it does not snow at all in NY. The second most commonly observed value is `NA`, indicating missingness. Other common values are 13, 25, and 51, suggesting that snowfall is originally recorded in fractions of an inch and converted to mm.

```{r}
ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))

ny_noaa = 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```
```{r}
ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Mean monthly temperature for each station across years for January and July")
```

Below we show a two-panel plot including (i) a hex plot of `tmax` vs `tmin` for the full dataset; and (ii) a ridge plot showing the distribution of snowfall values (in mm) greater than 0 and less than 100 separately by year. 

From the hex plot we see that while there is some variability, the majority of the data cluster tightly in the center of the distribution. In relatively rare cases, it seems that `tmax` is less than `tmin`, which raises questions about data recording and quality.

From the ridge plot, we see a multimodal density of snowfall within a given year. Most stations see between 0 and  35 mm of snow in a year. Then there is a another group of stations that see about 45 mm of snow, and another group that sees nearly 80 mm. It is likely this multimodality stems from the conversion of measurements in one system (fractions of an inch) to another (using the metric system), which was also noted in the table of common values. 

```{r}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

ridge = 
  ny_noaa %>% 
  filter(snow < 100, snow > 0) %>%
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()

hex + ridge
```



# Problem 2

```{r include=FALSE}
# Load datasets
covar <- read_csv("nhanes_covar.csv",skip = 4) %>%  
  janitor::clean_names()

accel <- read_csv("nhanes_accel.csv") %>%  
  janitor::clean_names()
```

```{r echo=FALSE}
# Clean data
covar <- covar %>%
  mutate(
    seqn = as.integer(seqn),
    age = as.integer(age),
    bmi = as.numeric(bmi),
    
    sex = case_when(
      sex == 1 ~ "Male",
      sex == 2 ~ "Female",
      TRUE ~ as.character(sex)
    ),
    
    education = case_when(
      education == 1 ~ "Less than high school",
      education == 2 ~ "High school equivalent",
      education == 3 ~ "More than high school",
      TRUE ~ as.character(education)  
    )
  )
view(covar)
```

```{r echo=FALSE}
# merge data
merged_data <- merge(covar, accel, by = "seqn", all = TRUE)
view(merged_data)


cleaned_data <- merged_data %>%
  filter(age >= 21) %>%    
  drop_na(sex, age, bmi, education) 

View(cleaned_data)
```

The cleaned_datat has `r nrow(cleaned_data)` observation and `r ncol(cleaned_data)` variables, after we cleaned and merged the data.

A reader-friendly table
```{r echo=FALSE}
#Produce a reader-friendly table 
education_gender_table <- cleaned_data %>%
  count(education, sex) %>%
  pivot_wider(names_from = sex, values_from = n, values_fill = 0) %>%
  mutate(Total = Female + Male) %>%
  arrange(education)  

print(education_gender_table)

```

```{r echo=FALSE}
# Create a single violin plot with gender differentiation
ggplot(cleaned_data, aes(x = education, y = age, fill = sex)) +
  geom_violin(alpha = 0.5, position = position_dodge(width = 0.8)) +  # Separate violins by gender within each education level
  stat_summary(fun = "median", geom = "point", position = position_dodge(width = 0.8), color = "blue", size = 2) +
  labs(
    title = "Age Distribution by Gender and Education Level",
    x = "Education Level",
    y = "Age",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5)
  )

```

This violin plot shows age distributions by gender across three education levels: "High school equivalent," "Less than high school," and "More than high school." Wider sections indicate higher age density, with blue dots marking medians. Both genders in "High school equivalent" have a uniform age spread around a median of 60, while "Less than high school" shows a broader age range, especially for males. The "More than high school" group has a younger, more concentrated age distribution, particularly among females. Overall, those with higher education tend to be younger, while "Less than high school" shows greater age variability.


```{r echo=FALSE}
# Aggregate total activity for each participant

agr_data <- cleaned_data %>%
  mutate(total_activity = rowSums(select(., starts_with("min")), na.rm = TRUE))%>%
  select(-starts_with("min"))

view(agr_data)
```

```{r echo=FALSE}
# creat the plot
ggplot(agr_data, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "loess", se = FALSE) +  # Add smooth trend lines
  facet_wrap(~education) +  
  labs(
    title = "Total Activity vs Age by Gender and Education Level",
    x = "Age",
    y = "Total Activity",
    color = "Gender"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5)
  )

```

This plot shows total activity decreasing with age across education levels, with notable differences by gender. In the "High school equivalent" group, men’s activity drops sharply around age 50 from about 15,000 to 10,000, while women decline more gradually. For those with "Less than high school" education, men’s activity falls steeply from around 13,000 in their 20s to below 5,000 by age 70, whereas women drop more steadily to about 7,000. The "More than high school" group maintains stable activity near 12,000 until age 50, then declines to around 8,000, with women showing more consistency than men. Higher education is associated with more stable activity levels across ages.

```{r include=FALSE}
activity_data <- cleaned_data %>%
  group_by(education, sex) %>%
  summarise(across(starts_with("min"), ~ mean(.), .names = "mean_{.col}"), .groups = "drop") %>%
  pivot_longer(cols = starts_with("mean_"), names_to = "time", values_to = "mean") %>%
  mutate(
    time = as.numeric(substring(time, 9)) / 60  # Convert time to hours
  )
```

```{r echo=FALSE}
#creat the table
ggplot(activity_data, aes(x = time, y = mean, color = sex)) +
  geom_line() +
  facet_wrap(education ~ ., labeller = labeller(education = as_labeller(education_gender_table))) +
  labs(title = "24-Hour Activity by Education and Gender",
       x = "Time (hours)",
       y = "Mean value of activity",
       color = "Gender") +
  theme_minimal() +
  scale_color_manual(values = c("pink", "#98FF98"), name = "Gender")
```

The figure shows 24-hour activity patterns by education level and gender. The "Less than high school" group has the highest morning and afternoon peaks, reaching around 17 units at 10:00 AM, suggesting more physically demanding routines. The "More than high school" group has lower, steadier peaks, topping at about 14 units, indicating structured daily schedules. Across all groups, activity begins increasing around 6:00 AM, peaks around 10:00 AM and 4:00 PM, and drops to about 5-6 units by midnight. Females consistently have slightly higher activity than males during peak hours, suggesting greater engagement in daily activities.

# Problem 3
```{r echo=FALSE}
# Import each file with year and month as identifiers
jan_2020 <- read_csv("Jan 2020 Citi.csv") %>%
  mutate(year = 2020, month = "Jan")

july_2020 <- read_csv("July 2020 Citi.csv") %>%
  mutate(year = 2020, month = "July")

jan_2024 <- read_csv("Jan 2024 Citi.csv") %>%
  mutate(year = 2024, month = "Jan")

july_2024 <- read_csv("July 2024 Citi.csv") %>%
  mutate(year = 2024, month = "July")
#combine
citi_bike_data <- bind_rows(jan_2020, july_2020, jan_2024, july_2024)

# Create a summary table showing total rides by year, month, and rider type
summary_table <- citi_bike_data %>%
  group_by(year, month, member_casual) %>%
  summarise(total_rides = n(), .groups = "drop") %>%
  pivot_wider(names_from = member_casual, values_from = total_rides, values_fill = 0) %>%
  rename(`Member Rides` = member, `Casual Rides` = casual)

print(summary_table)
```

The table shows significant growth in Citi Bike rides from 2020 to 2024, with both casual and member rides increasing. July consistently sees more rides than January, indicating a seasonal trend favoring warmer months. Member rides have risen sharply, particularly in July 2024 with 36,262 rides, suggesting a growing subscriber base. Members consistently outnumber casual riders, reflecting Citi Bike's success in attracting regular users. 

```{r echo=FALSE}
# Filter data for July 2024
july_2024_data <- citi_bike_data %>%
  filter(year == 2024, month == "July")
# Find the 5 most popular starting stations
top_starting_stations <- july_2024_data %>%
  count(start_station_name) %>%
  arrange(desc(n)) %>%
  slice_head(n = 5) %>%
  rename("Starting Station" = start_station_name, "Number of Rides" = n)

print(top_starting_stations)

```

The table shows the top five starting stations for Citi Bike rides in July 2024. Pier 61 at Chelsea Piers leads with 163 rides, followed by University Pl & E 14 St (155) and W 21 St & 6 Ave (152). West St & Chambers St and W 31 St & 7 Ave also rank high. 




```{r echo=FALSE}
median_duration <- citi_bike_data %>%
  group_by(year, month, weekdays) %>%
  summarise(median_duration = median(duration), .groups = 'drop')

median_duration$month <- factor(median_duration$month, levels = c("Jan", "July"))
median_duration$weekdays <- factor(median_duration$weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

# create a plot of the median ride duration with facets for year and month
ggplot(median_duration, aes(x = weekdays, y = median_duration, fill = month)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ year) +
  labs(
    title = "Median Ride Duration by Day of the Week, Month, and Year",
    x = "Day of the Week",
    y = "Median Ride Duration (minutes)",
    fill = "Month"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The plot shows that median ride durations are higher on weekends than weekdays, with July having consistently longer durations than January across both years. In 2024, ride durations appear slightly lower than in 2020, particularly in July, possibly due to the increased use of electric bikes for shorter trips. Overall, weekend and seasonal patterns indicate longer rides on weekends and in warmer months.

```{r echo=FALSE}
data_2024 <- citi_bike_data %>% 
  filter(year == 2024)

# correct order
data_2024$month <- factor(data_2024$month, levels = c("Jan", "July"))

# Calculate average ride duration by month, membership status, and bike type
avg_duration <- data_2024 %>%
  group_by(month, member_casual, rideable_type) %>%
  summarise(avg_duration = mean(duration), .groups = 'drop')

# create the plot
ggplot(avg_duration, aes(x = month, y = avg_duration, fill = rideable_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ member_casual) +
  labs(
    title = "Avg Ride Duration by Month, Membership, and Bike Type (2024)",
    x = "Month",
    y = "Average Ride Duration (minutes)",
    fill = "Bike Type"
  ) +
  theme_minimal()
```

The chart shows that in 2024, casual riders have longer average ride durations than members. Classic bikes are associated with longer rides than electric bikes across both groups. In July, ride durations are generally higher for both membership types and bike types compared to January.



